name: Issue Automation

on:
  issues:
    types: [opened, edited]

permissions:
  issues: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    name: Auto-label Issues
    steps:
      - name: Auto-label Bug Reports
        if: contains(github.event.issue.title, '[BUG]')
        uses: actions/github-script@v8
        with:
          script: |
            const labels = ['bug', 'needs-triage'];

            // Detectar severidade do body
            const body = context.payload.issue.body || '';
            if (body.includes('ğŸ”´ CrÃ­tico')) {
              labels.push('priority: critical');
            } else if (body.includes('ğŸŸ  Alto')) {
              labels.push('priority: high');
            } else if (body.includes('ğŸŸ¡ MÃ©dio')) {
              labels.push('priority: medium');
            } else if (body.includes('ğŸŸ¢ Baixo')) {
              labels.push('priority: low');
            }

            // Detectar mÃ³dulo
            if (body.includes('ğŸ” AutenticaÃ§Ã£o')) labels.push('module: auth');
            else if (body.includes('ğŸ  Home')) labels.push('module: home');
            else if (body.includes('âš½ Jogos')) labels.push('module: games');
            else if (body.includes('ğŸ‘¥ Grupos')) labels.push('module: groups');
            else if (body.includes('ğŸ“Š EstatÃ­sticas')) labels.push('module: stats');
            else if (body.includes('ğŸ® Live Game')) labels.push('module: live-game');
            else if (body.includes('ğŸ‘¤ Perfil')) labels.push('module: profile');
            else if (body.includes('ğŸ’° Caixa')) labels.push('module: cashbox');
            else if (body.includes('ğŸ¯ GamificaÃ§Ã£o')) labels.push('module: gamification');
            else if (body.includes('ğŸ”” NotificaÃ§Ãµes')) labels.push('module: notifications');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });

      - name: Auto-label Feature Requests
        if: contains(github.event.issue.title, '[FEATURE]')
        uses: actions/github-script@v8
        with:
          script: |
            const labels = ['enhancement', 'needs-discussion'];

            const body = context.payload.issue.body || '';

            // Detectar prioridade
            if (body.includes('ğŸ”´ Alta')) {
              labels.push('priority: high');
            } else if (body.includes('ğŸŸ¡ MÃ©dia')) {
              labels.push('priority: medium');
            } else if (body.includes('ğŸŸ¢ Baixa')) {
              labels.push('priority: low');
            }

            // Detectar categoria
            if (body.includes('âš½ Jogos')) labels.push('module: games');
            else if (body.includes('ğŸ‘¥ Grupos')) labels.push('module: groups');
            else if (body.includes('ğŸ“Š EstatÃ­sticas')) labels.push('module: stats');
            else if (body.includes('ğŸ® Live Game')) labels.push('module: live-game');
            else if (body.includes('ğŸ‘¤ Perfil')) labels.push('module: profile');
            else if (body.includes('ğŸ’° Financeiro')) labels.push('module: cashbox');
            else if (body.includes('ğŸ¯ GamificaÃ§Ã£o')) labels.push('module: gamification');
            else if (body.includes('ğŸ”” NotificaÃ§Ãµes')) labels.push('module: notifications');
            else if (body.includes('ğŸ¨ UI/UX')) labels.push('ui/ux');

            // Detectar plataforma
            if (body.includes('ğŸ“± Android')) labels.push('platform: android');
            if (body.includes('ğŸ iOS')) labels.push('platform: ios');
            if (body.includes('ğŸŒ Web')) labels.push('platform: web');

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });

      - name: Auto-label Improvements
        if: contains(github.event.issue.title, '[IMPROVEMENT]')
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['improvement', 'technical']
            });

      - name: Auto-label Documentation
        if: contains(github.event.issue.title, '[DOCS]')
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['documentation']
            });

  auto-comment:
    runs-on: ubuntu-latest
    name: Auto-comment on Critical Bugs
    steps:
      - name: Comment on Critical Bugs
        if: contains(github.event.issue.title, '[BUG]') && contains(github.event.issue.body, 'ğŸ”´ CrÃ­tico')
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âš ï¸ **Bug CrÃ­tico Detectado!**

              Este bug foi marcado como **crÃ­tico** e serÃ¡ priorizado para resoluÃ§Ã£o.

              ğŸ“Œ **PrÃ³ximos passos:**
              - [ ] Triage e validaÃ§Ã£o do bug
              - [ ] ReproduÃ§Ã£o em ambiente de desenvolvimento
              - [ ] AnÃ¡lise de impacto e urgÃªncia
              - [ ] AtribuiÃ§Ã£o para desenvolvedor

              Obrigado pelo relato detalhado! ğŸ™`
            });

  auto-project:
    runs-on: ubuntu-latest
    name: Add to Project Board
    steps:
      - name: Add Bug to Backlog
        if: contains(github.event.issue.title, '[BUG]')
        uses: actions/github-script@v8
        with:
          script: |
            // Adiciona comentÃ¡rio informando que foi adicionado ao backlog
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âœ… Issue adicionada ao backlog para triage.'
            });
