name: Deploy Beta to Firebase App Distribution

# #065 - Firebase App Distribution for Beta Testing
# Automatically deploys to Firebase when pushing to develop or via manual trigger

on:
  push:
    branches:
      - develop
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-beta:
    name: Build & Deploy Beta
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties with signing config
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "STORE_FILE=${{ secrets.KEYSTORE_PATH }}" >> local.properties
          echo "STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> local.properties
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> local.properties
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> local.properties

      - name: Decode and save keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > ${{ secrets.KEYSTORE_PATH }}

      - name: Create google-services.json
        run: |
          mkdir -p app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > app/google-services.json

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: Upload APK to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          groups: beta-testers
          file: app/build/outputs/apk/release/app-release.apk
          releaseNotes: |
            ðŸš€ New Beta Build Available!

            **Version:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}

            Changes in this build:
            ${{ github.event.head_commit.message }}

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/app-release.apk

      - name: Send Slack notification (optional)
        if: success()
        run: |
          # Uncomment if you have SLACK_WEBHOOK_URL secret configured
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"âœ… Beta build deployed to Firebase App Distribution!"}'
          echo "Beta deployment successful!"
