name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Cancela execucoes anteriores do mesmo PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Create google-services.json placeholder
        run: |
          mkdir -p app
          cat > app/google-services.json << 'GSEOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "placeholder",
              "storage_bucket": "placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                "android_client_info": { "package_name": "com.futebadosparcas" }
              },
              "api_key": [{ "current_key": "placeholder" }]
            }]
          }
          GSEOF

      - name: Check for spec file
        run: |
          # Verifica se o PR tem uma spec linkada (opcional - apenas warning)
          echo "Reminder: PRs should reference a spec file in /specs/"

      - name: Build Check
        run: ./gradlew compileDebugKotlin --no-daemon

      - name: Detekt (analise estatica com baseline)
        run: ./gradlew detekt --no-daemon

      - name: Unit Tests
        run: ./gradlew :app:testDebugUnitTest --no-daemon

      - name: Check for hardcoded strings
        run: |
          # Verifica se ha strings hardcoded em arquivos modificados
          HARDCODED=$(git diff origin/master --name-only -- '*.kt' | xargs grep -l 'text = "' 2>/dev/null | grep -v "Test" || true)
          if [ -n "$HARDCODED" ]; then
            echo "::warning::Possible hardcoded strings found in: $HARDCODED"
          fi

      - name: Check for hardcoded colors
        run: |
          HARDCODED_COLORS=$(git diff origin/master --name-only -- '*.kt' | xargs grep -l 'Color\.\(Black\|White\|Gray\)' 2>/dev/null | grep -v "Test\|theme\|Theme\|Gamification" || true)
          if [ -n "$HARDCODED_COLORS" ]; then
            echo "::warning::Possible hardcoded colors found in: $HARDCODED_COLORS"
          fi
