name: Android CI

on:
  push:
    branches: [ master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'specs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/BRANCH_STRATEGY.md'
      - 'functions/**'
  pull_request:
    branches: [ master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'specs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - 'functions/**'
  workflow_dispatch:

# Cancela execucoes anteriores do mesmo branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # ============================================================
  # Job de setup reutilizavel - prepara o ambiente Android
  # ============================================================
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Create google-services.json placeholder
        run: |
          mkdir -p app
          cat > app/google-services.json << 'GSEOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "placeholder",
              "storage_bucket": "placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                "android_client_info": { "package_name": "com.futebadosparcas" }
              },
              "api_key": [{ "current_key": "placeholder" }]
            }]
          }
          GSEOF

      - name: Run Lint
        run: ./gradlew lint --no-daemon

      - name: Upload Lint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            app/build/reports/lint-results-debug.html
            app/build/reports/lint-results-debug.xml
          retention-days: 14

  detekt:
    name: Detekt Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Create google-services.json placeholder
        run: |
          mkdir -p app
          cat > app/google-services.json << 'GSEOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "placeholder",
              "storage_bucket": "placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                "android_client_info": { "package_name": "com.futebadosparcas" }
              },
              "api_key": [{ "current_key": "placeholder" }]
            }]
          }
          GSEOF

      # Detekt usa baseline (detekt-baseline.xml) para ignorar violacoes pre-existentes
      - name: Run Detekt
        run: ./gradlew detekt --no-daemon

      - name: Upload Detekt SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: app/build/reports/detekt/detekt.sarif
        continue-on-error: true

      - name: Upload Detekt Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-report
          path: |
            app/build/reports/detekt/
            build/reports/detekt/
          retention-days: 14

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Create google-services.json placeholder
        run: |
          mkdir -p app
          cat > app/google-services.json << 'GSEOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "placeholder",
              "storage_bucket": "placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                "android_client_info": { "package_name": "com.futebadosparcas" }
              },
              "api_key": [{ "current_key": "placeholder" }]
            }]
          }
          GSEOF

      - name: Run Unit Tests
        run: ./gradlew :app:testDebugUnitTest --no-daemon

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            app/build/reports/tests/
            app/build/test-results/
          retention-days: 14

      # Publicar resultados dos testes como check no PR
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: app/build/test-results/**/*.xml
          check_name: "Unit Test Results"
        continue-on-error: true

  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [ lint, detekt, test ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Create google-services.json placeholder
        run: |
          mkdir -p app
          cat > app/google-services.json << 'GSEOF'
          {
            "project_info": {
              "project_number": "000000000000",
              "project_id": "placeholder",
              "storage_bucket": "placeholder.appspot.com"
            },
            "client": [{
              "client_info": {
                "mobilesdk_app_id": "1:000000000000:android:0000000000000000000000",
                "android_client_info": { "package_name": "com.futebadosparcas" }
              },
              "api_key": [{ "current_key": "placeholder" }]
            }]
          }
          GSEOF

      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      # Tamanho do APK como comentario no PR
      - name: Report APK Size
        if: github.event_name == 'pull_request'
        run: |
          APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "### APK Size: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
