rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // CMD-11: AUTHZ REAL (AUTORIZAÇÃO NO BACKEND)
    // ============================================
    //
    // IMPORTANTE: As regras abaixo são a ÚNICA fonte de verdade
    // para autorização no backend. Verificações no cliente (UI)
    // são apenas para UX - a segurança real está aqui.
    //
    // Como funciona:
    // 1. role é definido no campo 'role' do documento users/{userId}
    // 2. Valores possíveis: 'ADMIN', 'FIELD_OWNER', 'PLAYER'
    // 3. A função isAdmin() verifica se role == 'ADMIN'
    // 4. Para operações sensíveis, SEMPRE verificar ownership E role
    //
    // Matriz de Permissões (deve corresponder a UserPermissions.kt):
    //
    // | Ação                    | ADMIN | FIELD_OWNER | PLAYER |
    // |-------------------------|-------|-------------|--------|
    // | Criar jogo              | ✓     | ✓           | ✓      |
    // | Editar qualquer jogo    | ✓     | próprios    | próprios|
    // | Deletar qualquer jogo   | ✓     | próprios    | próprios|
    // | Criar local             | ✓     | ✓           | ✗      |
    // | Editar qualquer local   | ✓     | próprios    | ✗      |
    // | Deletar local           | ✓     | ✗           | ✗      |
    // | Gerenciar usuários      | ✓     | ✗           | ✗      |
    // | Ver stats globais       | ✓     | leitura     | leitura |
    // | Editar rankings         | ✓     | ✗           | ✗      |
    // | Ajustar XP              | ✓     | ✗           | ✗      |
    //
    // ============================================

    // ============================================
    // FUNCOES AUXILIARES
    // ============================================

    // Verifica se o usuario esta autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Retorna o ID do usuario autenticado
    function userId() {
      return request.auth.uid;
    }

    // Verifica se o usuario e o dono do documento
    function isOwner(ownerId) {
      return isAuthenticated() && userId() == ownerId;
    }

    // Verifica se um campo nao foi alterado
    function fieldUnchanged(field) {
      return !(field in request.resource.data) ||
             request.resource.data[field] == resource.data[field];
    }

    // Valida que apenas campos permitidos foram modificados
    function onlyAllowedFields(allowedFields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // CMD-10: Obtem o role do usuario autenticado com validacao de null
    // O role é definido no campo 'role' do documento users/{userId}
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc != null ? userDoc.data.role : null;
    }

    // CMD-10/11: Verifica se o usuario e ADMIN
    // Usado para operações administrativas em todo o sistema
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }

    // Verifica se o usuario e um jogador confirmado no jogo (C-002 fix)
    function isConfirmedPlayer(gameId) {
      let confirmationDoc = get(/databases/$(database)/documents/confirmations/$(gameId + "_" + userId()));
      return confirmationDoc != null;
    }

    // Helper global unico para verificar se o usuario e dono do jogo (C-005 fix)
    // Esta funcao deve ser usada em todas as colecoes que precisam verificar ownership de jogos
    function isGameOwner(gameId) {
      let gameDoc = get(/databases/$(database)/documents/games/$(gameId));
      return gameDoc != null && gameDoc.data.owner_id == userId();
    }

    // Helper para verificar se usuario e membro ativo de um grupo
    function isGroupMember(groupId) {
      let memberDoc = get(/databases/$(database)/documents/groups/$(groupId)/members/$(userId()));
      return memberDoc != null && memberDoc.data.status == 'ACTIVE';
    }

    // Helper para verificar se usuario e admin/owner de um grupo
    function isGroupAdmin(groupId) {
      let memberDoc = get(/databases/$(database)/documents/groups/$(groupId)/members/$(userId()));
      return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
    }

    // C-003 FIX: Valida se o ID de confirmation segue o padrao esperado
    // Padrão: {gameId}_{userId}
    function isValidConfirmationId(confirmationId, gameId, userId) {
      return confirmationId == (gameId + '_' + userId);
    }

    // Helper para verificar se o grupo esta ativo
    function isGroupActive(groupId) {
      let groupDoc = get(/databases/$(database)/documents/groups/$(groupId));
      return groupDoc != null && (groupDoc.data.status == 'ACTIVE' || !('status' in groupDoc.data));
    }

    // ============================================
    // FUNCOES DE VALIDACAO DE DADOS
    // ============================================

    // Valida tamanho de string (min e max)
    function isValidStringLength(value, min, max) {
      return value is string && value.size() >= min && value.size() <= max;
    }

    // Valida formato de email (basico)
    function isValidEmail(email) {
      return email == null || email == '' || email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    // Valida rating no range 0.0 - 5.0
    function isValidRating(rating) {
      return rating == null || (rating >= 0.0 && rating <= 5.0);
    }

    // Valida league rating no range 0.0 - 100.0
    function isValidLeagueRating(rating) {
      return rating == null || (rating >= 0.0 && rating <= 100.0);
    }

    // Valida level no range 0 - 10
    function isValidLevel(level) {
      return level == null || (level >= 0 && level <= 10);
    }

    // Valida valor positivo (> 0)
    function isPositiveNumber(value) {
      return value is number && value > 0;
    }

    // Valida valor nao-negativo (>= 0)
    function isNonNegativeNumber(value) {
      return value is number && value >= 0;
    }

    // Valida nome (2-100 caracteres)
    function isValidName(name) {
      return name is string && name.size() >= 2 && name.size() <= 100;
    }

    // Valida descricao (max 500 caracteres)
    function isValidDescription(desc) {
      return desc == null || desc == '' || (desc is string && desc.size() <= 500);
    }

    // ============================================
    // COLECAO: users
    // ============================================
    match /users/{userId} {
      // S-001 FIX: Restringir leitura - apenas proprio usuario ou admin pode ver perfil completo
      // Exceção: usuarios marcados como is_searchable podem ser lidos por qualquer autenticado
      allow read: if isOwner(userId) || isAdmin() || (isAuthenticated() && resource.data.is_searchable == true);

      // Usuario so pode criar seu proprio perfil (com role padrao PLAYER)
      // Validações de dados obrigatorias na criacao
      allow create: if isOwner(userId) &&
                       request.resource.data.role == 'PLAYER' &&
                       // Validacao de nome (2-100 chars)
                       isValidName(request.resource.data.name) &&
                       // Validacao de email (formato valido)
                       isValidEmail(request.resource.data.email) &&
                       // Validacao de ratings (0.0-5.0)
                       isValidRating(request.resource.data.striker_rating) &&
                       isValidRating(request.resource.data.mid_rating) &&
                       isValidRating(request.resource.data.defender_rating) &&
                       isValidRating(request.resource.data.gk_rating);

      // Usuario pode atualizar seu perfil (campos basicos apenas)
      // XP/Level/Milestones SAO atualizados via Cloud Functions (Admin SDK) - NAO client-side
      // SEGURANCA: Removida permissao de FIELD_OWNER editar XP (vulnerabilidade P0-1)
      //
      // CMD-05: Regras de atualizacao de perfil
      // Campos permitidos para edicao pelo usuario:
      // - name, nickname, photo_url (dados basicos)
      // - preferred_field_types, preferred_position (preferencias)
      // - striker_rating, mid_rating, defender_rating, gk_rating (ratings manuais)
      // - birth_date, gender, height_cm, weight_kg (dados pessoais)
      // - dominant_foot, primary_position, secondary_position, play_style, experience_years
      //
      // Campos protegidos (apenas admin/cloud functions):
      // - id, created_at, role (identidade e permissões)
      // - experience_points, level, milestones_achieved (gamificacao)
      // - fcm_token (gerenciado internamente)
      // - auto_*_rating, auto_rating_samples (ratings automaticos)
      allow update: if
          isAdmin() ||
          (isOwner(userId) &&
           // Campos imutaveis (identidade)
           fieldUnchanged('id') &&
           fieldUnchanged('created_at') &&
           fieldUnchanged('role') &&
           // Campos de gamificacao (apenas cloud functions)
           fieldUnchanged('experience_points') &&
           fieldUnchanged('level') &&
           fieldUnchanged('milestones_achieved') &&
           // Campos de rating automatico (apenas cloud functions)
           fieldUnchanged('auto_striker_rating') &&
           fieldUnchanged('auto_mid_rating') &&
           fieldUnchanged('auto_defender_rating') &&
           fieldUnchanged('auto_gk_rating') &&
           fieldUnchanged('auto_rating_samples') &&
           fieldUnchanged('auto_rating_updated_at') &&
           // FCM token e flags internas
           fieldUnchanged('fcm_token') &&
           fieldUnchanged('updated_at') &&
           // Validacao de dados no update
           isValidName(request.resource.data.name) &&
           isValidEmail(request.resource.data.email) &&
           isValidRating(request.resource.data.striker_rating) &&
           isValidRating(request.resource.data.mid_rating) &&
           isValidRating(request.resource.data.defender_rating) &&
           isValidRating(request.resource.data.gk_rating));

      allow delete: if false;
    }

    // ============================================
    // COLECAO: statistics
    // ============================================
    match /statistics/{statId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
      allow delete: if false;
    }

    // ============================================
    // COLECAO: games
    // ============================================
    match /games/{gameId} {
      // Qualquer usuario autenticado pode ler jogos
      allow read: if isAuthenticated();

      // Qualquer usuario autenticado pode criar jogos
      // Validacoes na criacao de jogo
      allow create: if isAuthenticated() &&
                       (isAdmin() || request.resource.data.owner_id == userId()) &&
                       // Validacao de max_players (> 0)
                       isPositiveNumber(request.resource.data.max_players) &&
                       // Validacao de scores (>= 0)
                       isNonNegativeNumber(request.resource.data.team1_score) &&
                       isNonNegativeNumber(request.resource.data.team2_score) &&
                       // Validacao de contadores (>= 0)
                       isNonNegativeNumber(request.resource.data.players_count) &&
                       isNonNegativeNumber(request.resource.data.goalkeepers_count);

      // Apenas o dono pode atualizar o jogo
      // Excecao: contadores (players_count, goalkeepers_count) podem ser
      // atualizados por qualquer autenticado (via transacao de confirmacao)
      // Admins têm acesso total
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Dono pode fazer qualquer atualizacao (com validacao de dados)
        (resource.data.owner_id == userId() &&
         isNonNegativeNumber(request.resource.data.team1_score) &&
         isNonNegativeNumber(request.resource.data.team2_score) &&
         isNonNegativeNumber(request.resource.data.players_count) &&
         isNonNegativeNumber(request.resource.data.goalkeepers_count)) ||
        // Outros usuarios so podem atualizar contadores via transacao
        (onlyAllowedFields(['players_count', 'goalkeepers_count']) &&
         isNonNegativeNumber(request.resource.data.players_count) &&
         isNonNegativeNumber(request.resource.data.goalkeepers_count)) ||
        // Permitir que jogadores confirmados atualizem o MVP no final da votacao
        (isConfirmedPlayer(gameId) && onlyAllowedFields(['mvp_id']))
      );

      // Apenas o dono ou admin pode deletar
      allow delete: if isAdmin() || isOwner(resource.data.owner_id);
    }

    // ============================================
    // COLECAO: schedules
    // ============================================
    // CMD-07: Ownership de Horarios
    // - O campo owner_id define quem criou/gestiona o schedule (usuario)
    // - location_id vincula o schedule a um local/quadra (referencia)
    // - group_id vincula o schedule a um grupo (opcional, para jogos recorrentes de grupo)
    //
    // Nota: Schedules sao criados/gestionados por USUARIOS, nao por locais ou grupos diretamente.
    // Um usuario com role FIELD_OWNER pode criar schedules para o local que gerencia.
    match /schedules/{scheduleId} {
      // Usuario pode ler suas proprias recorrencias
      // Admins podem ler todas
      // Membros de um grupo podem ler schedules do grupo (se group_id definido)
      allow read: if isAuthenticated() &&
        (resource.data.owner_id == userId() ||
         isAdmin() ||
         (resource.data.group_id in keys(getAllIds(getMatchingDocuments(/databases/$(database)/documents/groups/$(resource.data.group_id)/members)))));

      // Usuario pode criar recorrencias para si mesmo
      // Admins podem criar para qualquer um
      // Se tiver group_id, o usuario deve ser membro do grupo
      allow create: if isAuthenticated() &&
        (request.resource.data.owner_id == userId() || isAdmin()) &&
        (request.resource.data.group_id == null ||
         isGroupMember(request.resource.data.group_id));

      // Usuario pode atualizar suas proprias recorrencias
      // Admins podem atualizar qualquer uma
      allow update: if isAuthenticated() &&
        (resource.data.owner_id == userId() || isAdmin());

      // Usuario pode deletar suas proprias recorrencias
      // Admins podem deletar qualquer uma
      allow delete: if isAuthenticated() &&
        (resource.data.owner_id == userId() || isAdmin());
    }

    // ============================================
    // COLECAO: confirmations
    // ============================================
    match /confirmations/{confirmationId} {
      // Qualquer usuario autenticado pode ler confirmacoes
      allow read: if isAuthenticated();

      // C-003 FIX: Usuario pode criar sua propria confirmacao com validação de ID
      // ID deve seguir padrao: {gameId}_{userId}
      // OU o dono do jogo pode criar convites (summon) para outros
      allow create: if isAuthenticated() &&
                       ((request.resource.data.user_id == userId() &&
                         isValidConfirmationId(confirmationId, request.resource.data.game_id, userId())) ||
                        (isGameOwner(request.resource.data.game_id) &&
                         // Para summon, o ID não precisa seguir o padrão gameId_userId pois pode ser convite para outro usuário
                         request.resource.data.game_id != null));

      // Usuario pode atualizar sua propria confirmacao
      allow update: if isAuthenticated() && (
        // O dono da confirmação pode atualizar (sem restrição de campos por enquanto, ou restringir se necessário)
        (resource.data.user_id == userId()) ||
        // O dono do JOGO pode atualizar qualquer confirmação (necessário para setar MVP/Stats no final)
        isGameOwner(resource.data.game_id) ||
        // Jogadores confirmados podem atualizar flags de MVP (para votação)
        (isConfirmedPlayer(resource.data.game_id) &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['is_mvp', 'is_best_gk', 'is_worst_player']))
      );

      // Usuario pode deletar sua propria confirmacao
      // OU dono do jogo / admin pode remover qualquer jogador
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.user_id == userId() ||
        isGameOwner(resource.data.game_id)
      );
    }

    // ============================================
    // COLECAO: teams
    // ============================================
    match /teams/{teamId} {
      // Qualquer usuario autenticado pode ler times
      allow read: if isAuthenticated();

      // Apenas dono do jogo ou admin pode criar/modificar times
      allow create, update, delete: if isAuthenticated() &&
                                       (isAdmin() || isGameOwner(request.resource.data.game_id));
    }

    // ============================================
    // COLECAO: statistics
    // ============================================


    // ============================================
    // COLECAO: player_stats (estatisticas por jogo)
    // ============================================
    match /player_stats/{statId} {
      // Qualquer usuario autenticado pode ler
      allow read: if isAuthenticated();

      // Dono do jogo ou admin pode criar/atualizar estatisticas de jogadores
      allow create, update: if isAuthenticated() &&
                               (isAdmin() || isGameOwner(request.resource.data.game_id));

      allow delete: if isAuthenticated() &&
                       (isAdmin() || isGameOwner(resource.data.game_id));
    }

    // ============================================
    // COLECAO: live_games (estado em tempo real)
    // ============================================
    match /live_games/{gameId} {
      allow read: if isAuthenticated();

      // Apenas dono do jogo ou admin pode controlar o jogo ao vivo
      allow create, update, delete: if isAuthenticated() &&
                                       (isAdmin() || isGameOwner(gameId));

      // Sub-colecao: eventos do jogo
      match /events/{eventId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAuthenticated() &&
                                         (isAdmin() || isGameOwner(gameId) || isConfirmedPlayer(gameId));
      }
    }

    // ============================================
    // COLECAO: locations
    // ============================================
    match /locations/{locationId} {
      // Qualquer usuario autenticado pode ler locais
      allow read: if isAuthenticated();

      // Qualquer usuario autenticado pode criar locais
      allow create: if isAuthenticated() &&
                       request.resource.data.owner_id == userId();

      // Apenas o dono ou admin pode atualizar o local
      allow update: if isAuthenticated() && (
                       isAdmin() ||
                       (resource.data.owner_id == userId() &&
                       fieldUnchanged('owner_id') &&
                       fieldUnchanged('created_at') &&
                       fieldUnchanged('is_active') &&
                       fieldUnchanged('is_verified'))
                    );

      allow delete: if isAuthenticated() && isAdmin();
    }

    // ============================================
    // COLECAO: fields (quadras/campos)
    // ============================================
    match /fields/{fieldId} {
      // Qualquer usuario autenticado pode ler quadras
      allow read: if isAuthenticated();

      // Apenas dono do local ou admin pode criar quadras
      allow create: if isAuthenticated() &&
                       (isAdmin() || isLocationOwner(request.resource.data.location_id));

      // Apenas dono do local ou admin pode atualizar quadras
      allow update: if isAuthenticated() &&
                       (isAdmin() || (isLocationOwner(resource.data.location_id) && fieldUnchanged('location_id') && fieldUnchanged('is_active')));

      allow delete: if isAuthenticated() && isAdmin();

      function isLocationOwner(locationId) {
        let locDoc = get(/databases/$(database)/documents/locations/$(locationId));
        return locDoc != null && locDoc.data.owner_id == userId();
      }
    }

    // ============================================
    // COLECAO: groups
    // ============================================
    match /groups/{groupId} {
      allow read: if isAuthenticated() && (
        resource.data.is_public == true ||
        resource.data.owner_id == userId() ||
        exists(/databases/$(database)/documents/groups/$(groupId)/members/$(userId()))
      );

      // Validacoes na criacao de grupo
      allow create: if isAuthenticated() &&
                       request.resource.data.owner_id == userId() &&
                       // Nome do grupo: 3-50 caracteres
                       isValidStringLength(request.resource.data.name, 3, 50) &&
                       // Descricao: max 500 caracteres
                       isValidDescription(request.resource.data.description);

      // Validacoes no update de grupo
      allow update: if isAuthenticated() && (
        isAdmin() ||
        (
          (resource.data.owner_id == userId() || isGroupAdmin(groupId)) &&
          // Validacao de dados no update
          isValidStringLength(request.resource.data.name, 3, 50) &&
          isValidDescription(request.resource.data.description)
        ) ||
        // Atualizacao de contadores permitida
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['member_count', 'updated_at'])
      );

      allow delete: if isAuthenticated() && (isAdmin() || resource.data.owner_id == userId());

      // Sub-colecao: members
      match /members/{memberId} {
        allow read: if isAuthenticated();

        allow create, update: if isAuthenticated() && (
           isGroupAdmin(groupId) ||
           (memberId == userId() && isGroupOwnerById(groupId)) ||
           (request.resource.data.role == 'OWNER' && request.resource.data.user_id == userId() && !exists(/databases/$(database)/documents/groups/$(groupId))) ||
           (request.resource.data.role == 'MEMBER' && request.resource.data.user_id == userId())
        );

        allow delete: if isAuthenticated() && (
          memberId == userId() ||
          isGroupAdmin(groupId)
        );

        function isGroupOwnerById(gId) {
          let groupDoc = get(/databases/$(database)/documents/groups/$(gId));
          return groupDoc != null && groupDoc.data.owner_id == userId();
        }
      }

      match /cashbox/{entryId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);

        allow create: if isAuthenticated() &&
                         isGroupAdmin(groupId) &&
                         isGroupActive(groupId) &&
                         request.resource.data.amount > 0 &&
                         (request.resource.data.type == 'INCOME' || request.resource.data.type == 'EXPENSE');

        // M-001 fix: validacao de timestamp em voided_at
        allow update: if isAuthenticated() && isGroupAdmin(groupId) &&
                      isGroupActive(groupId) &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'voided_at', 'voided_by']) &&
                      request.resource.data.status == 'VOIDED' &&
                      request.resource.data.voided_by == userId() &&
                      request.resource.data.voided_at == request.time;

        allow delete: if false;
      }

      match /cashbox_summary/{docId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && isGroupAdmin(groupId);
      }
    }

    // ============================================
    // COLECAO: group_invites
    // ============================================
    match /group_invites/{inviteId} {
      function canManageInvites(gId) {
        let member = get(/databases/$(database)/documents/groups/$(gId)/members/$(request.auth.uid));
        return member != null && (member.data.role == 'OWNER' || member.data.role == 'ADMIN');
      }

      allow read: if isAuthenticated() && (
        resource.data.invited_user_id == userId() ||
        resource.data.invited_by_id == userId() ||
        canManageInvites(resource.data.group_id)
      );

      allow create: if isAuthenticated() &&
                       request.resource.data.invited_by_id == userId() &&
                       canManageInvites(request.resource.data.group_id);

      allow update: if isAuthenticated() && (
        resource.data.invited_user_id == userId() ||
        resource.data.invited_by_id == userId()
      );

      allow delete: if isAuthenticated() && (
        resource.data.invited_by_id == userId() ||
        canManageInvites(resource.data.group_id)
      );
    }

    // ============================================
    // COLECAO: game_summons
    // ============================================
    match /game_summons/{summonId} {
      allow read: if isAuthenticated() && (
        resource.data.user_id == userId() ||
        resource.data.summoned_by == userId()
      );

      allow create: if isAuthenticated();

      allow update: if isAuthenticated() && resource.data.user_id == userId();

      allow delete: if isAuthenticated() && (
        resource.data.summoned_by == userId() ||
        isAdmin()
      );
    }

    // ============================================
    // COLECAO: notifications
    // ============================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.user_id == userId();

      // C-003 fix: validacao de created_by e user_id
      allow create: if isAuthenticated() &&
                       request.resource.data.created_by == userId() &&
                       request.resource.data.user_id != userId() &&
                       exists(/databases/$(database)/documents/users/$(request.resource.data.user_id)) &&
                       request.resource.data.keys().hasAll(['created_by', 'user_id', 'type', 'title']);

      allow update: if isAuthenticated() &&
                       resource.data.user_id == userId() &&
                       onlyAllowedFields(['read', 'read_at']);

      allow delete: if isAuthenticated() && resource.data.user_id == userId();
    }

    // ============================================
    // SUB-COLECAO: users/{userId}/groups
    // ============================================
    match /users/{userId}/groups/{groupId} {
      allow read: if isAuthenticated() && userId == userId();
      allow create, update, delete: if isAuthenticated() && (
        userId == userId() ||
        isGroupAdmin(groupId)
      );

      function isGroupAdmin(gId) {
        let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(request.auth.uid));
        return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
      }
    }

    // ============================================
    // SUB-COLECAO: users/{userId}/upcoming_games
    // ============================================
    match /users/{userId}/upcoming_games/{gameId} {
      allow read: if isAuthenticated() && userId == userId();
      allow create, update, delete: if isAuthenticated() && (
        userId == userId() ||
        isGameOwner(gameId)
      );
    }

    // ============================================
    // COLECAO: game_events (eventos de jogos ao vivo)
    // ============================================
    match /game_events/{eventId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(request.resource.data.game_id) ||
        isConfirmedPlayer(request.resource.data.game_id)
      );

      allow update: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(resource.data.game_id) ||
        isConfirmedPlayer(resource.data.game_id)
      );

      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(resource.data.game_id) ||
        isConfirmedPlayer(resource.data.game_id)
      );
    }

    // ============================================
    // COLECAO: live_scores (placar ao vivo)
    // ============================================
    match /live_scores/{scoreId} {
      allow read: if isAuthenticated();

      allow create, update: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(scoreId) ||
        isConfirmedPlayer(scoreId)
      );

      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(scoreId)
      );
    }

    // ============================================
    // COLECAO: live_player_stats (estatisticas ao vivo)
    // ============================================
    match /live_player_stats/{statId} {
      allow read: if isAuthenticated();

      allow create, update: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(request.resource.data.game_id) ||
        isConfirmedPlayer(request.resource.data.game_id)
      );

      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isGameOwner(resource.data.game_id)
      );
    }

    // ============================================
    // COLECAO: mvp_votes (votacao MVP)
    // ============================================
    match /mvp_votes/{voteId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() && (
        isConfirmedPlayer(request.resource.data.game_id) &&
        request.resource.data.voter_id == userId()
      );

      allow update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: xp_logs (historico de XP)
    // ============================================
    match /xp_logs/{logId} {
      allow read: if isAuthenticated() && resource.data.user_id == userId();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // ============================================
    // COLECAO: ranking_deltas (incrementos de ranking)
    // ============================================
    match /ranking_deltas/{deltaId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated() && (
        isAdmin() ||
        (request.resource.data.keys().hasAll(['game_id']) && isGameOwner(request.resource.data.game_id))
      );

      allow update: if isAuthenticated() && (
        isAdmin() ||
        (resource.data.keys().hasAll(['game_id']) && isGameOwner(resource.data.game_id))
      );
    }

    // ============================================
    // COLECAO: rankings (rankings consolidados)
    // ============================================
    match /rankings/{rankingId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: seasons (Controle de Ligas)
    // ============================================
    match /seasons/{seasonId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: season_participation (Ligas)
    // ============================================
    match /season_participation/{partId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
    }

    // ============================================
    // COLECAO: user_streaks
    // ============================================
    match /user_streaks/{streakId} {
      allow read: if isAuthenticated();
      allow create, update: if isAdmin();
    }

    // ============================================
    // COLECAO: user_badges
    // ============================================
    match /user_badges/{badgeId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
    }

    // ============================================
    // COLECAO: game_requests (FASE 1 - Solicitações de Jogos Publicos)
    // ============================================
    match /game_requests/{requestId} {
      // Qualquer usuario autenticado pode ler suas proprias solicitacoes
      // Dono do jogo pode ler todas as solicitacoes do seu jogo
      allow read: if isAuthenticated() &&
        (resource.data.user_id == userId() || isGameOwner(resource.data.game_id));

      // C-006 fix: Usuario pode criar solicitacao apenas para si mesmo
      // Validacoes adicionais para prevenir abuso:
      // 1. user_id deve ser o proprio usuario
      // 2. status deve ser PENDING
      // 3. game_id deve existir
      // 4. Campos obrigatorios devem estar presentes
      allow create: if isAuthenticated() &&
        request.resource.data.user_id == userId() &&
        request.resource.data.status == 'PENDING' &&
        exists(/databases/$(database)/documents/games/$(request.resource.data.game_id)) &&
        request.resource.data.keys().hasAll(['user_id', 'game_id', 'status']);

      // Dono do jogo pode aprovar/rejeitar (update status)
      // Validacao: apenas status, reviewed_at, reviewed_by, rejection_reason podem ser alterados
      allow update: if isAuthenticated() &&
        isGameOwner(resource.data.game_id) &&
        onlyAllowedFields(['status', 'reviewed_at', 'reviewed_by', 'rejection_reason']);

      allow delete: if isAuthenticated() && (
        resource.data.user_id == userId() ||
        isGameOwner(resource.data.game_id)
      );
    }

    // ============================================
    // COLECAO: activities (feed de atividades)
    // ============================================
    match /activities/{activityId} {
      // C-004 fix: validacao de visibility e created_by
      allow read: if isAuthenticated() && (
        resource.data.visibility == 'PUBLIC' ||
        resource.data.created_by == userId()
      );

      allow create: if isAuthenticated() &&
                       request.resource.data.created_by == userId() &&
                       (request.resource.data.visibility == 'PUBLIC' || request.resource.data.visibility == 'PRIVATE') &&
                       request.resource.data.keys().hasAll(['created_by', 'user_id', 'type', 'visibility']);

      allow update, delete: if isAuthenticated() &&
                               resource.data.created_by == userId() &&
                               fieldUnchanged('created_by');
    }

    // ============================================
    // COLECAO: challenges (desafios semanais)
    // ============================================
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: challenge_progress (progresso dos desafios)
    // ============================================
    match /challenge_progress/{progressId} {
      allow read: if isAuthenticated() && resource.data.userId == userId();

      // Usuario pode criar/atualizar seu proprio progresso
      allow create, update: if isAuthenticated() && request.resource.data.userId == userId();

      // Admin pode gerenciar qualquer progresso
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // APP SETTINGS - Configurações globais do app (XP rates, etc)
    // CMD-12: Proteção de configurações de gamificação
    // ============================================
    match /app_settings/{docId} {
      // Qualquer usuário autenticado pode ler configurações
      allow read: if isAuthenticated();

      // Apenas ADMINs podem criar/modificar configurações
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // GAME TEMPLATES - Templates de jogos salvos por usuário
    // CMD-12: Templates são privados por usuário
    // ============================================
    match /users/{userId}/game_templates/{templateId} {
      // Usuário só pode ler seus próprios templates
      allow read: if isOwner(userId);

      // Usuário só pode criar/modificar/deletar seus próprios templates
      allow create, update, delete: if isOwner(userId);
    }

    // ============================================
    // SEASON FINAL STANDINGS - Rankings finais de temporadas encerradas
    // CMD-12: Histórico de rankings é público, edição apenas admin
    // ============================================
    match /season_final_standings/{standingId} {
      // Qualquer usuário autenticado pode ler rankings históricos
      allow read: if isAuthenticated();

      // Apenas Admin ou Cloud Functions podem criar/modificar
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // BADGES - Definições de badges (metadata)
    // CMD-12: Badges metadata é público, edição apenas admin
    // ============================================
    match /badges/{badgeId} {
      // Qualquer usuário autenticado pode ler definições de badges
      allow read: if isAuthenticated();

      // Apenas Admin pode criar/modificar badges
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // REGRA PADRAO: Negar tudo que nao foi explicitamente permitido
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
