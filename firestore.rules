rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // FUNCOES AUXILIARES
    // ============================================

    // Verifica se o usuario esta autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Retorna o ID do usuario autenticado
    function userId() {
      return request.auth.uid;
    }

    // Verifica se o usuario e o dono do documento
    function isOwner(ownerId) {
      return isAuthenticated() && userId() == ownerId;
    }

    // Verifica se um campo nao foi alterado
    function fieldUnchanged(field) {
      return !(field in request.resource.data) ||
             request.resource.data[field] == resource.data[field];
    }

    // Valida que apenas campos permitidos foram modificados
    function onlyAllowedFields(allowedFields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // Verifica se e uma data valida (timestamp)
    // function isValidTimestamp(field) {
    //   return field is timestamp;
    // }

    // Obtem o role do usuario autenticado
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Verifica se o usuario e ADMIN
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'ADMIN';
    }

    // Verifica se o usuario e FIELD_OWNER ou ADMIN
    // function isFieldOwner() {
    //   return isAuthenticated() && (getUserRole() == 'FIELD_OWNER' || getUserRole() == 'ADMIN');
    // }

    // Verifica se o usuario e pelo menos PLAYER (qualquer autenticado)
    // function isPlayer() {
    //   return isAuthenticated();
    // }

    // Verifica se e um usuario mock (ficticio)
    function isMock(id) {
      return id.matches('mock_user_.*');
    }

    // Verifica se o usuario e um jogador confirmado no jogo
    function isConfirmedPlayer(gameId) {
      return exists(/databases/$(database)/documents/confirmations/$(gameId + "_" + userId()));
    }

    // ============================================
    // COLECAO: users
    // ============================================
    match /users/{userId} {
      // Qualquer usuario autenticado pode ler perfis publicos
      allow read: if isAuthenticated();

      // Usuario so pode criar seu proprio perfil (com role padrao PLAYER)
      allow create: if (isOwner(userId) && request.resource.data.role == 'PLAYER') ||
                       (isAuthenticated() && isMock(userId));

      // Usuario pode atualizar seu perfil
      // Admin/FieldOwner pode atualizar campos de gamificação de outros usuários (XP/Level)
      allow update: if 
          isAdmin() || 
          (isOwner(userId) && fieldUnchanged('id') && fieldUnchanged('created_at') && fieldUnchanged('role')) || 
          (isAuthenticated() && isMock(userId)) ||
          // Permissão para Gamificação Client-Side:
          (isAuthenticated() && (getUserRole() == 'FIELD_OWNER' || getUserRole() == 'ADMIN') && 
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['experience_points', 'level', 'milestones_achieved', 'updated_at']));

      allow delete: if (isAuthenticated() && isMock(userId)) || false;
    }

    // ... (games, confirmations, teams rules remain unchanged) ...
    // NOTE: Keeping the structure intact, skipping lines 98-215 for brevity in this replacement block if possible, but tool requires contiguous block.
    // I will use multiple ReplaceChunks for cleaner diff.

    // ... (games, confirmations, teams rules remain unchanged) ...

    // ============================================
    // COLECAO: statistics
    // ============================================
    match /statistics/{statId} {
      allow read: if isAuthenticated();
      
      // Permitir atualização por donos de quadra/admins para processar jogos de terceiros
      allow create, update: if isAuthenticated() && (
          statId == userId() || 
          isMock(statId) || 
          getUserRole() == 'FIELD_OWNER' || 
          getUserRole() == 'ADMIN'
      );

      allow delete: if isAuthenticated() && isMock(statId);
    }
    
    // ... (player_stats rules remain unchanged) ...

    // ============================================
    // COLECAO: xp_logs (historico de XP)
    // ============================================


    // ============================================
    // COLECAO: games
    // ============================================
    match /games/{gameId} {
      // Qualquer usuario autenticado pode ver jogos
      allow read: if isAuthenticated();

      // Qualquer usuario autenticado pode criar jogos
      // Permitir criar jogos como mock_admin
      allow create: if isAuthenticated() &&
                       (isAdmin() || request.resource.data.owner_id == userId() || request.resource.data.owner_id == 'mock_admin');

      // Apenas o dono pode atualizar o jogo
      // Excecao: contadores (players_count, goalkeepers_count) podem ser
      // atualizados por qualquer autenticado (via transacao de confirmacao)
      // Mocks podem ser atualizados por qualquer um
      // Apenas o dono pode atualizar o jogo
      // Admins têm acesso total
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Dono pode fazer qualquer atualizacao
        resource.data.owner_id == userId() ||
        resource.data.owner_id == 'mock_admin' ||
        // Outros usuarios so podem atualizar contadores via transacao
        onlyAllowedFields(['players_count', 'goalkeepers_count']) ||
        // Permitir que jogadores confirmados atualizem o MVP no final da votacao
        (isConfirmedPlayer(gameId) && onlyAllowedFields(['mvp_id']))
      );

      // Apenas o dono ou admin pode deletar (ou mocks)
      allow delete: if isAdmin() || isOwner(resource.data.owner_id) || resource.data.owner_id == 'mock_admin';
    }

    // ============================================
    // COLECAO: schedules
    // ============================================
    match /schedules/{scheduleId} {
      // Usuario pode ler suas proprias recorrencias
      // Admins podem ler todas
      allow read: if isAuthenticated() && (resource.data.owner_id == userId() || isAdmin());

      // Usuario pode criar recorrencias para si mesmo
      // Admins podem criar para qualquer um
      allow create: if isAuthenticated() && (request.resource.data.owner_id == userId() || isAdmin());

      // Usuario pode atualizar suas proprias recorrencias
      // Admins podem atualizar qualquer uma
      allow update: if isAuthenticated() && (resource.data.owner_id == userId() || isAdmin());

      // Usuario pode deletar suas proprias recorrencias
      // Admins podem deletar qualquer uma
      allow delete: if isAuthenticated() && (resource.data.owner_id == userId() || isAdmin());
    }

    // ============================================
    // COLECAO: confirmations
    // ============================================
    match /confirmations/{confirmationId} {
      // Qualquer usuario autenticado pode ler confirmacoes
      allow read: if isAuthenticated();

      // Usuario pode criar sua propria confirmacao
      // ID deve seguir padrao: {gameId}_{userId}
      // OU criar confirmacao para mock users
      // OU o dono do jogo pode criar convites (summon) para outros
      allow create: if isAuthenticated() &&
                       (request.resource.data.user_id == userId() || 
                        isMock(request.resource.data.user_id) ||
                        isGameOwner(request.resource.data.game_id));

      // Usuario pode atualizar sua propria confirmacao
      // OU se for mock
      allow update: if isAuthenticated() && (
        // O dono da confirmação pode atualizar (sem restrição de campos por enquanto, ou restringir se necessário)
        (resource.data.user_id == userId()) ||
        // O dono do JOGO pode atualizar qualquer confirmação (necessário para setar MVP/Stats no final)
        isGameOwner(resource.data.game_id) ||
        // Jogadores confirmados podem atualizar flags de MVP (para votação)
        (isConfirmedPlayer(resource.data.game_id) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['is_mvp', 'is_best_gk', 'is_worst_player']))
      );

      // Usuario pode deletar sua propria confirmacao
      // OU dono do jogo / admin pode remover qualquer jogador
      allow delete: if isAuthenticated() && (
        isAdmin() ||
        resource.data.user_id == userId() ||
        isMock(resource.data.user_id) ||
        isGameOwner(resource.data.game_id)
      );

      // Funcao auxiliar para verificar dono do jogo
      function isGameOwner(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin'; 
      }
    }

    // ============================================
    // COLECAO: teams
    // ============================================
    match /teams/{teamId} {
      // Qualquer usuario autenticado pode ler times
      allow read: if isAuthenticated();

      // Apenas dono do jogo ou admin pode criar/modificar times
      allow create, update, delete: if isAuthenticated() &&
                                       (isAdmin() || isGameOwnerForTeam(request.resource.data.game_id));

      function isGameOwnerForTeam(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin';
      }
    }

    // ============================================
    // COLECAO: statistics
    // ============================================


    // ============================================
    // COLECAO: player_stats (estatisticas por jogo)
    // ============================================
    match /player_stats/{statId} {
      // Qualquer usuario autenticado pode ler
      allow read: if isAuthenticated();

      // Dono do jogo ou admin pode criar/atualizar estatisticas de jogadores
      allow create, update: if isAuthenticated() &&
                               (isAdmin() || isGameOwnerForStats(request.resource.data.game_id));

      allow delete: if isAuthenticated() &&
                       (isAdmin() || isGameOwnerForStats(resource.data.game_id));

      function isGameOwnerForStats(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin';
      }
    }

    // ============================================
    // COLECAO: live_games (estado em tempo real)
    // ============================================
    match /live_games/{gameId} {
      allow read: if isAuthenticated();

      // Apenas dono do jogo ou admin pode controlar o jogo ao vivo
      allow create, update, delete: if isAuthenticated() &&
                                       (isAdmin() || isGameOwnerForLive(gameId));

      function isGameOwnerForLive(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin';
      }

      // Sub-colecao: eventos do jogo
      match /events/{eventId} {
        allow read: if isAuthenticated();
        // Uses global isConfirmedPlayer(gameId) helper
        allow create, update, delete: if isAuthenticated() &&
                                         (isAdmin() || isGameOwnerForLiveEvent(gameId) || isConfirmedPlayer(gameId));

        function isGameOwnerForLiveEvent(gId) {
          let owner = get(/databases/$(database)/documents/games/$(gId)).data.owner_id;
          return owner == userId() || owner == 'mock_admin';
        }
      }
    }

    // ============================================
    // COLECAO: locations
    // ============================================
    match /locations/{locationId} {
      // Qualquer usuario autenticado pode ler locais
      allow read: if isAuthenticated();

      // Qualquer usuario autenticado pode criar locais
      // Permitir criar locations como mock_admin
      allow create: if isAuthenticated() &&
                       (request.resource.data.owner_id == userId() || request.resource.data.owner_id == 'mock_admin');

      // Apenas o dono ou admin pode atualizar o local (ou mocks)
      allow update: if isAuthenticated() && (
                       isAdmin() || 
                       ((resource.data.owner_id == userId() || resource.data.owner_id == 'mock_admin') &&
                       fieldUnchanged('owner_id') &&
                       fieldUnchanged('created_at') &&
                       fieldUnchanged('is_active') &&
                       fieldUnchanged('is_verified'))
                    );

      // Apenas o dono ou admin pode deletar (ou mocks)
      // Apenas admin pode deletar (ou mocks se necessário, mas regra diz nunca apagar)
      allow delete: if isAuthenticated() && (isAdmin());
    }

    // ============================================
    // COLECAO: fields (quadras/campos)
    // ============================================
    match /fields/{fieldId} {
      // Qualquer usuario autenticado pode ler quadras
      allow read: if isAuthenticated();

      // Apenas dono do local ou admin pode criar quadras
      allow create: if isAuthenticated() &&
                       (isAdmin() || isLocationOwner(request.resource.data.location_id));

      // Apenas dono do local ou admin pode atualizar quadras
      allow update: if isAuthenticated() &&
                       (isAdmin() || (isLocationOwner(resource.data.location_id) && fieldUnchanged('location_id') && fieldUnchanged('is_active')));

      // Apenas dono do local ou admin pode deletar quadras
      // Apenas admin pode deletar quadras
      allow delete: if isAuthenticated() && (isAdmin());

      function isLocationOwner(locationId) {
        let locDoc = get(/databases/$(database)/documents/locations/$(locationId));
        return locDoc != null && (locDoc.data.owner_id == userId() || locDoc.data.owner_id == 'mock_admin');
      }
    }

    // ============================================
    // COLECAO: groups
    // ============================================
    match /groups/{groupId} {
      // Qualquer usuario autenticado pode ler grupos
      allow read: if isAuthenticated();

      // Usuario autenticado pode criar grupos
      allow create: if isAuthenticated() && request.resource.data.owner_id == userId();

      // Apenas owner ou admin do grupo pode atualizar
      allow update: if isAuthenticated() && (
        isAdmin() ||
        resource.data.owner_id == userId() ||
        isGroupAdmin(groupId) ||
        // Permitir atualizacao do contador de membros por qualquer usuario autenticado (para join/leave)
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['member_count', 'updated_at'])
      );

      // Apenas owner pode deletar (soft delete)
      allow delete: if isAuthenticated() && (isAdmin() || resource.data.owner_id == userId());

      // Funcao para verificar se e admin do grupo
      function isGroupAdmin(gId) {
        let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(userId()));
        return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
      }

      // Funcao para verificar se e owner do grupo (usando get direto no grupo)
      // Necessario quando a subcolecao members ainda nao foi criada
      function isGroupOwner(gId) {
        let groupDoc = get(/databases/$(database)/documents/groups/$(gId));
        return groupDoc != null && groupDoc.data.owner_id == userId();
      }

      // Sub-colecao: members
      match /members/{memberId} {
        allow read: if isAuthenticated();
        
        // Permitir criar/atualizar se:
        // 1. O usuario e admin/owner na subcolecao (logica existente)
        // 2. OU se o usuario e o owner definido no documento pai (group) e esta se adicionando
        // 3. OU se esta criando um membro OWNER e o grupo ainda nao existe (criacao atomica)
        // 4. OU se o usuario esta entrando como MEMBER (aceitando convite)
        allow create, update: if isAuthenticated() && (
           isGroupAdminForMembers(groupId) || 
           (memberId == userId() && isGroupOwner(groupId)) ||
           (request.resource.data.role == 'OWNER' && request.resource.data.user_id == userId() && !exists(/databases/$(database)/documents/groups/$(groupId))) ||
           (request.resource.data.role == 'MEMBER' && request.resource.data.user_id == userId())
        );

        allow delete: if isAuthenticated() && (
          memberId == userId() ||  // Usuario pode sair
          isGroupAdminForMembers(groupId)  // Admin pode remover
        );

        function isGroupAdminForMembers(gId) {
          let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(userId()));
          return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
        }
      }

      // ... existing cashbox rules ...
      match /cashbox/{entryId} {
        allow read: if isAuthenticated() && isGroupMember(groupId);
        
        // Admin ou Dono podem criar lançamentos
        // REGRAS ADICIONAIS:
        // 1. Grupo deve estar ATIVO
        // 2. Valor (amount) deve ser positivo
        allow create: if isAuthenticated() && 
                         isGroupAdminForCashbox(groupId) && 
                         isGroupActive(groupId) &&
                         request.resource.data.amount > 0 &&
                         (request.resource.data.type == 'INCOME' || request.resource.data.type == 'EXPENSE');
        
        // Apenas o Dono pode estornar (Soft Delete)
        allow update: if isAuthenticated() && isGroupOwner(groupId) && 
                      isGroupActive(groupId) &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'voided_at', 'voided_by']) &&
                      request.resource.data.status == 'VOIDED' &&
                      request.resource.data.voided_by == userId() &&
                      request.resource.data.voided_at == request.time;
        
        // Ninguém pode deletar fisicamente (Hard Delete)
        allow delete: if false;

        function isGroupAdminForCashbox(gId) {
          let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(userId()));
          return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
        }
        function isGroupMember(gId) {
          let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(userId()));
          return memberDoc != null && memberDoc.data.status == 'ACTIVE';
        }
        function isGroupActive(gId) {
          let groupDoc = get(/databases/$(database)/documents/groups/$(gId));
          return groupDoc != null && (groupDoc.data.status == 'ACTIVE' || !('status' in groupDoc.data));
        }
      }

      match /cashbox_summary/{docId} {
        allow read: if isAuthenticated();
        allow create, update: if isAuthenticated() && isGroupAdminForSummary(groupId);
        function isGroupAdminForSummary(gId) {
          let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(userId()));
          return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
        }
      }
    }

    // ============================================
    // COLECAO: group_invites
    // ============================================
    // ============================================
    // COLECAO: group_invites
    // ============================================
    match /group_invites/{inviteId} {
      function canManageInvites(gId) {
        let member = get(/databases/$(database)/documents/groups/$(gId)/members/$(request.auth.uid));
        return member != null && (member.data.role == 'OWNER' || member.data.role == 'ADMIN');
      }

      // Leitura permitida se:
      // 1. Sou o convitado
      // 2. Sou quem convidou
      // 3. Sou Admin/Owner do grupo (para checar duplicatas)
      allow read: if isAuthenticated() && (
        resource.data.invited_user_id == userId() ||
        resource.data.invited_by_id == userId() ||
        canManageInvites(resource.data.group_id)
      );

      // Criacao permitida se:
      // 1. Sou Admin/Owner do grupo (validado em canManageInvites)
      // 2. E estou me listando como 'invited_by' (seguranca basica)
      allow create: if isAuthenticated() && 
                       request.resource.data.invited_by_id == userId() &&
                       canManageInvites(request.resource.data.group_id);

      // Destinatario pode aceitar/recusar, remetente pode cancelar
      allow update: if isAuthenticated() && (
        resource.data.invited_user_id == userId() ||  // Destinatario
        resource.data.invited_by_id == userId()       // Remetente
      );

      allow delete: if isAuthenticated() && (
        resource.data.invited_by_id == userId() ||
        canManageInvites(resource.data.group_id)
      );
    }

    // ============================================
    // COLECAO: game_summons
    // ============================================
    match /game_summons/{summonId} {
      // Convocado pode ler suas convocacoes
      allow read: if isAuthenticated() && (
        resource.data.user_id == userId() ||
        resource.data.summoned_by == userId()
      );

      // Criador do jogo pode criar convocacoes
      allow create: if isAuthenticated();

      // Convocado pode responder
      allow update: if isAuthenticated() && resource.data.user_id == userId();

      allow delete: if isAuthenticated() && (
        resource.data.summoned_by == userId() ||
        isAdmin()
      );
    }

    // ============================================
    // COLECAO: notifications
    // ============================================
    match /notifications/{notificationId} {
      // Usuario so pode ler suas proprias notificacoes
      allow read: if isAuthenticated() && resource.data.user_id == userId();

      // Sistema cria notificacoes (via app ou Cloud Functions)
      allow create: if isAuthenticated();

      // Usuario pode marcar como lida
      allow update: if isAuthenticated() &&
                       resource.data.user_id == userId() &&
                       onlyAllowedFields(['read', 'read_at']);

      allow delete: if isAuthenticated() && resource.data.user_id == userId();
    }

    // ============================================
    // SUB-COLECAO: users/{userId}/groups
    // ============================================
    match /users/{userId}/groups/{groupId} {
      allow read: if isAuthenticated() && userId == userId();
      // Permitir escrita se for o proprio usuario
      // OU se for um admin/owner do grupo (para atualizar metadados denormalizados)
      allow create, update, delete: if isAuthenticated() && (
        userId == userId() || 
        isGroupAdmin(groupId)
      );

      function isGroupAdmin(gId) {
        let memberDoc = get(/databases/$(database)/documents/groups/$(gId)/members/$(request.auth.uid));
        return memberDoc != null && (memberDoc.data.role == 'OWNER' || memberDoc.data.role == 'ADMIN');
      }
    }

    // ============================================
    // SUB-COLECAO: users/{userId}/upcoming_games
    // ============================================
    match /users/{userId}/upcoming_games/{gameId} {
      allow read: if isAuthenticated() && userId == userId();
      // Permitir escrita se for o proprio usuario
      // OU se for admin do jogo
      allow create, update, delete: if isAuthenticated() && (
        userId == userId() ||
        isGameOwner(gameId)
      );

      function isGameOwner(gId) {
        let owner = get(/databases/$(database)/documents/games/$(gId)).data.owner_id;
        return owner == request.auth.uid || owner == 'mock_admin';
      }
    }

    // ============================================
    // COLECAO: game_events (eventos de jogos ao vivo)
    // ============================================
    match /game_events/{eventId} {
      // Qualquer usuario autenticado pode ler eventos
      allow read: if isAuthenticated();

      // Usuario pode criar/atualizar eventos se for:
      // 1. Owner do jogo
      // 2. Jogador confirmado no jogo
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForEvent(request.resource.data.game_id) ||
        // Use global helper
        isConfirmedPlayer(request.resource.data.game_id)
      );

      allow update: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForEvent(resource.data.game_id) ||
        isConfirmedPlayer(resource.data.game_id)
      );

      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForEvent(resource.data.game_id) ||
        isConfirmedPlayer(resource.data.game_id)
      );

      function isGameOwnerForEvent(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin';
      }
    }

    // ============================================
    // COLECAO: live_scores (placar ao vivo)
    // ============================================
    match /live_scores/{scoreId} {
      // Qualquer usuario autenticado pode ler placar
      allow read: if isAuthenticated();

      // Usuario pode criar/atualizar placar se for owner ou jogador confirmado
      allow create, update: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForScore(scoreId) ||
        // Assuming scoreId is gameId
        isConfirmedPlayer(scoreId)
      );

      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForScore(scoreId)
      );

      function isGameOwnerForScore(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin';
      }
    }

    // ============================================
    // COLECAO: live_player_stats (estatisticas ao vivo)
    // ============================================
    match /live_player_stats/{statId} {
      // Qualquer usuario autenticado pode ler
      allow read: if isAuthenticated();

      // Usuario pode criar/atualizar stats se for owner ou jogador confirmado
      allow create, update: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForLiveStats(request.resource.data.game_id) ||
        isConfirmedPlayer(request.resource.data.game_id)
      );

      allow delete: if isAuthenticated() && (
        isAdmin() ||
        isGameOwnerForLiveStats(resource.data.game_id)
      );

      function isGameOwnerForLiveStats(gameId) {
        let owner = get(/databases/$(database)/documents/games/$(gameId)).data.owner_id;
        return owner == userId() || owner == 'mock_admin';
      }
    }

    // ============================================
    // COLECAO: mvp_votes (votacao MVP)
    // ============================================
    match /mvp_votes/{voteId} {
      // Qualquer usuario autenticado pode ler votos
      allow read: if isAuthenticated();

      // Usuario pode criar voto se for jogador confirmado no jogo
      allow create: if isAuthenticated() && (
        isConfirmedPlayer(request.resource.data.game_id) &&
        request.resource.data.voter_id == userId()
      );

      // Nao pode atualizar ou deletar votos
      allow update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: xp_logs (historico de XP)
    // ============================================
    match /xp_logs/{logId} {
      // Usuario pode ler seu proprio historico
      allow read: if isAuthenticated() && resource.data.user_id == userId();

      // Sistema cria logs (via transacao no app ou Cloud Functions)
      allow create: if isAuthenticated() && request.resource.data.user_id == userId();

      // Nao pode editar ou deletar logs
      allow update, delete: if false;
    }

    // ============================================
    // COLECAO: ranking_deltas (incrementos de ranking)
    // ============================================
    match /ranking_deltas/{deltaId} {
      // Qualquer usuario autenticado pode ler
      allow read: if isAuthenticated();

      // Permitir que o sistema (via admin/field owner/game owner) crie
      // Como não há resource.data no create, a validação de diff falha.
      // Assumimos que a creation é controlada por backend ou lógica de app confiável por enquanto, 
      // ou validamos apenas integridade básica se possível.
      allow create: if isAuthenticated(); 
      
      // Permitir update com restrição de campos
      allow update: if isAuthenticated() && (
        isAdmin() ||
        // Verifica se é um update de incremento vindo de um jogo válido
        (request.resource.data.diff(resource.data).affectedKeys().hasAny(['goals_added', 'assists_added', 'xp_added', 'games_added', 'wins_added', 'updated_at']))
      );
    }

    // ============================================
    // COLECAO: rankings (rankings consolidados)
    // ============================================
    match /rankings/{rankingId} {
      // Qualquer usuario autenticado pode ler
      allow read: if isAuthenticated();

      // Apenas admin pode criar/atualizar (via Cloud Functions ou admin)
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: seasons (Controle de Ligas)
    // ============================================
    match /seasons/{seasonId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // COLECAO: season_participation (Ligas)
    // ============================================
    match /season_participation/{partId} {
      allow read: if isAuthenticated();
      // Permitir update pelo MatchFinalizationService
      allow create, update: if isAuthenticated();
    }

    // ============================================
    // COLECAO: user_streaks
    // ============================================
    match /user_streaks/{streakId} {
      allow read: if isAuthenticated();
      // Permitir update pelo BadgeAwarder (Game Owner)
      allow create, update: if isAuthenticated(); // Simplificado para permitir funcionamento inicial, ideal seria validar owner do jogo
    }

    // ============================================
    // COLECAO: user_badges
    // ============================================
    match /user_badges/{badgeId} {
      allow read: if isAuthenticated();
      // Permitir create pelo BadgeAwarder
      allow create: if isAuthenticated(); 
    }

    // ============================================
    // REGRA PADRAO: Negar tudo que nao foi explicitamente permitido
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
